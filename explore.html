<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Music Stories - Musicstory</title>
    <link rel="stylesheet" href="explore.css">
</head>
<body>
    <!-- Header/Navigation -->
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <h1>Musicstory</h1>
            </div>
            <nav class="navigation">
                <a href="index.html" class="nav-link">Home</a>
                <a href="explore.html" class="nav-link active">Explore</a>
                <a href="hits.html" class="nav-link">Top hits</a>
            </nav>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search songs...">
                <button class="search-button">Search</button>
            </div>
            <div class="user-info" id="user-info" style="margin-left: 20px; color: white;">
                <a href="login.html" class="nav-link" id="auth-link">Login</a>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Explore Music Stories</h1>
            <p class="hero-description">
                Dive deep into the fascinating world of music and discover the stories behind your favorite songs
            </p>
        </div>
    </section>

    <!-- Featured Song Section -->
    <section class="featured-section">
        <div class="container">
            <h2 class="section-title">Featured Song</h2>
            
            <div class="featured-song">
                <div class="song-image">
                    <img src="./pics/gloc.jpg" alt="Love Story by Gloc 9" onerror="this.src='https://via.placeholder.com/200x200?text=Love+Story'" />
                </div>
                
                <div class="song-info">
                    <h3 class="song-title">Love Story</h3>
                    <p class="artist-name">By Gloc 9</p>
                    
                    <div class="song-description">
                        <p>"Love Story" by Gloc 9 is a powerful Filipino hip-hop track that tells a compelling narrative about love in the face of social and economic challenges. Known for his socially conscious lyrics, Gloc 9 weaves a story that resonates with many Filipinos, touching on themes of perseverance, hope, and the struggles of everyday life while maintaining love and relationships.</p>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="https://open.spotify.com/search/Love%20Story%20Gloc%209" target="_blank" class="btn btn-spotify">Listen on Spotify</a>
                        <a href="#lovestory-modal" class="btn btn-secondary">See more information</a>
                        <button class="btn btn-like" id="like-lovestory" onclick="toggleSongLike('lovestory')">
                            <span class="heart-icon">ü§ç</span> <span class="like-count">0</span>
                        </button>
                        <button class="btn btn-comment" onclick="toggleComments('lovestory')">Comments</button>
                    </div>
                    
                    <!-- Comment Section for Love Story -->
                    <div id="lovestory-comments" class="comment-section" style="display: none;">
                        <h4>Share Your Understanding</h4>
                        <p class="comment-subtitle">Express what this song means to you</p>
                        
                        <div class="comment-form">
                            <textarea class="comment-text" placeholder="Share your thoughts about the story behind this music..." rows="4"></textarea>
                            <button class="btn-submit-comment" onclick="submitComment('lovestory')">Post Comment</button>
                        </div>
                        
                        <div class="comments-list" id="lovestory-comments-list">
                            <!-- Comments will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pahina by Cup of Joe -->
            <div class="featured-song">
                <div class="song-image">
                    <img src="./pics/OIP.jpeg" alt="Pahina by Cup of Joe" onerror="this.src='https://via.placeholder.com/200x200?text=Pahina'" />
                </div>
                
                <div class="song-info">
                    <h3 class="song-title">Pahina</h3>
                    <p class="artist-name">By Cup of Joe</p>
                    
                    <div class="song-description">
                        <p>The song "Pahina" by Cup of Joe, released on January 17, 2025, as part of their album "Silakbo," delves into the intricate themes of love, longing, and the bittersweet nature of relationships. This poignant track captures the essence of nostalgia, reflecting on cherished moments shared with a loved one while also acknowledging the emotional complexities that accompany such connections. The title "Pahina," which translates to "page" in English, symbolizes the turning of pages in a book, representing the various chapters of life and love that shape our experiences.</p>
                    </div>
                    
                    <div class="action-buttons">
                        <a href="https://open.spotify.com/search/Pahina%20Cup%20of%20Joe" target="_blank" class="btn btn-spotify">Listen on Spotify</a>
                        <a href="#pahina-modal" class="btn btn-secondary">See more information</a>
                        <button class="btn btn-like" id="like-pahina" onclick="toggleSongLike('pahina')">
                            <span class="heart-icon">ü§ç</span> <span class="like-count">0</span>
                        </button>
                        <button class="btn btn-comment" onclick="toggleComments('pahina')">Comments</button>
                    </div>
                    
                    <!-- Comment Section for Pahina -->
                    <div id="pahina-comments" class="comment-section" style="display: none;">
                        <h4>Share Your Understanding</h4>
                        <p class="comment-subtitle">Express what this song means to you</p>
                        
                        <div class="comment-form">
                            <textarea class="comment-text" placeholder="Share your thoughts about the story behind this music..." rows="4"></textarea>
                            <button class="btn-submit-comment" onclick="submitComment('pahina')">Post Comment</button>
                        </div>
                        
                        <div class="comments-list" id="pahina-comments-list">
                            <!-- Comments will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <!-- Love Story Modal -->
    <div id="lovestory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Love Story - Gloc 9</h2>
                <a href="#" class="close">&times;</a>
            </div>
            <div class="modal-body">
                <div class="modal-song-info">
                    <img src="./pics/gloc.jpg" alt="Love Story by Gloc 9" class="modal-image" onerror="this.src='https://via.placeholder.com/150x150?text=Love+Story'" />
                    <div class="modal-details">
                        <h3>Artist: Gloc 9</h3>
                        <p><strong>Genre:</strong> Filipino Hip-Hop, OPM Rap</p>
                        <p><strong>Language:</strong> Filipino/Tagalog</p>
                        <p><strong>Artist:</strong> Gloc 9 (Aristotle Pollisco)</p>
                        <p><strong>Style:</strong> Socially Conscious Rap</p>
                    </div>
                </div>
                <div class="modal-description">
                    <h4>About the Song</h4>
                    <p>"Love Story" by Gloc 9 is a powerful Filipino hip-hop track that tells a compelling narrative about love in the face of social and economic challenges. Known for his socially conscious lyrics, Gloc 9 weaves a story that resonates with many Filipinos, touching on themes of perseverance, hope, and the struggles of everyday life while maintaining love and relationships.</p>
                    
                    <p>Gloc 9, one of the most respected rappers in the Philippines, is known for his ability to blend storytelling with social commentary. His songs often highlight the realities faced by ordinary Filipinos, making his music both relatable and thought-provoking.</p>
                    
                    <p>"Love Story" showcases Gloc 9's signature style of rapid-fire delivery combined with meaningful lyrics. The track demonstrates his mastery of wordplay and his commitment to creating music that speaks to the Filipino experience, making it a standout piece in OPM hip-hop.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Pahina Modal -->
    <div id="pahina-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pahina - Cup of Joe</h2>
                <a href="#" class="close">&times;</a>
            </div>
            <div class="modal-body">
                <div class="modal-song-info">
                    <img src="./pics/OIP.jpeg" alt="Pahina by Cup of Joe" class="modal-image" onerror="this.src='https://via.placeholder.com/150x150?text=Pahina'" />
                    <div class="modal-details">
                        <h3>Album: Silakbo</h3>
                        <p><strong>Release Date:</strong> January 17, 2025</p>
                        <p><strong>Genre:</strong> OPM, Indie Pop</p>
                        <p><strong>Artist:</strong> Cup of Joe</p>
                        <p><strong>Language:</strong> Filipino</p>
                    </div>
                </div>
                <div class="modal-description">
                    <h4>About the Song</h4>
                    <p>The song "Pahina" by Cup of Joe, released on January 17, 2025, as part of their album "Silakbo," delves into the intricate themes of love, longing, and the bittersweet nature of relationships. This poignant track captures the essence of nostalgia, reflecting on cherished moments shared with a loved one while also acknowledging the emotional complexities that accompany such connections.</p>
                    
                    <p>The title "Pahina," which translates to "page" in English, symbolizes the turning of pages in a book, representing the various chapters of life and love that shape our experiences. The song's lyrics explore how relationships evolve over time, with each moment becoming a page in the story of two people's lives.</p>
                    
                    <p>Musically, "Pahina" showcases Cup of Joe's signature sound, blending contemporary OPM with indie pop sensibilities. The song's gentle melody and heartfelt delivery make it a standout track that resonates with listeners who have experienced the complexities of love and relationships.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 Musicstory. Celebrating Filipino Music.</p>
    </footer>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://ytfgpayqcnodpoqgbxcg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZmdwYXlxY25vZHBvcWdieGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MDUyMzQsImV4cCI6MjA3OTI4MTIzNH0.Hy7eJkL-u_pVoT_QqHhgeAIdFe620y7IYlITed9So6o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Check authentication and update UI
        let currentUser = null;
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                // Not logged in, redirect to login page
                window.location.href = 'login.html';
                return;
            }
            
            if (session) {
                currentUser = session.user;
                const authLink = document.getElementById('auth-link');
                authLink.textContent = `Logout (${session.user.email})`;
                authLink.href = '#';
                authLink.onclick = async (e) => {
                    e.preventDefault();
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                };
                
                // Set up real-time subscriptions after authentication
                setupRealtimeSubscriptions();
            }
        });

        // Real-time subscriptions for live updates
        function setupRealtimeSubscriptions() {
            // Subscribe to song_likes changes
            supabase
                .channel('song_likes_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'song_likes' },
                    async (payload) => {
                        console.log('Like change detected:', payload);
                        const songId = payload.new.song_id || payload.old?.song_id;
                        if (songId) {
                            await updateLikeDisplay(songId);
                        }
                    }
                )
                .subscribe();

            // Subscribe to user_song_likes changes
            supabase
                .channel('user_likes_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'user_song_likes' },
                    async (payload) => {
                        console.log('User like change detected:', payload);
                        const songId = payload.new?.song_id || payload.old?.song_id;
                        if (songId) {
                            await updateLikeDisplay(songId);
                        }
                    }
                )
                .subscribe();

            // Subscribe to comments changes
            supabase
                .channel('comments_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'comments' },
                    async (payload) => {
                        console.log('Comment change detected:', payload);
                        const songId = payload.new?.song_id || payload.old?.song_id;
                        if (songId) {
                            const commentSection = document.getElementById(`${songId}-comments`);
                            // Only reload if comments section is visible
                            if (commentSection && commentSection.style.display !== 'none') {
                                await loadComments(songId);
                            }
                        }
                    }
                )
                .subscribe();
        }

        // Update like display in real-time
        async function updateLikeDisplay(songId) {
            const button = document.getElementById(`like-${songId}`);
            if (!button) return;
            
            const heartIcon = button.querySelector('.heart-icon');
            const likeCount = button.querySelector('.like-count');
            
            const likesData = await getSongLikes(songId);
            const isLiked = await getUserLikeStatus(songId);
            
            likeCount.textContent = likesData.count || 0;
            if (isLiked) {
                button.classList.add('liked');
                heartIcon.textContent = '‚ù§Ô∏è';
            } else {
                button.classList.remove('liked');
                heartIcon.textContent = 'ü§ç';
            }
        }

        // Search functionality
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('.search-button');
        const featuredSongs = document.querySelectorAll('.featured-song');

        // Function to perform search
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            featuredSongs.forEach(song => {
                const title = song.querySelector('.song-title').textContent.toLowerCase();
                const artist = song.querySelector('.artist-name').textContent.toLowerCase();
                const description = song.querySelector('.song-description').textContent.toLowerCase();
                
                // Check if search term matches title, artist, or description
                if (title.includes(searchTerm) || artist.includes(searchTerm) || description.includes(searchTerm)) {
                    song.style.display = 'flex';
                    song.style.animation = 'fadeIn 0.5s ease';
                } else {
                    song.style.display = 'none';
                }
            });

            // If search is empty, show all songs
            if (searchTerm === '') {
                featuredSongs.forEach(song => {
                    song.style.display = 'flex';
                });
            }
        }

        // Search on button click
        searchButton.addEventListener('click', performSearch);

        // Search on Enter key press
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Real-time search as user types
        searchInput.addEventListener('input', performSearch);

        // Add fade-in animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        // Song Like functionality with Supabase
        async function getSongLikes(songId) {
            const { data, error } = await supabase
                .from('song_likes')
                .select('*')
                .eq('song_id', songId)
                .single();
            
            if (error && error.code !== 'PGRST116') {
                console.error('Error fetching likes:', error);
                return { count: 0 };
            }
            
            return data || { count: 0 };
        }

        async function getUserLikeStatus(songId) {
            const userId = generateUserId();
            const { data, error } = await supabase
                .from('user_song_likes')
                .select('*')
                .eq('song_id', songId)
                .eq('user_id', userId)
                .maybeSingle();
            
            if (error) {
                console.error('Error checking like status:', error);
                return false;
            }
            
            return data ? true : false;
        }

        function generateUserId() {
            // Use authenticated user ID if logged in, otherwise use anonymous ID
            if (currentUser) {
                return currentUser.id;
            }
            
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        async function toggleSongLike(songId) {
            const userId = generateUserId();
            const button = document.getElementById(`like-${songId}`);
            const heartIcon = button.querySelector('.heart-icon');
            const likeCount = button.querySelector('.like-count');
            
            // Disable button during processing
            button.disabled = true;
            
            try {
                const isLiked = await getUserLikeStatus(songId);
                
                if (isLiked) {
                    // Unlike - Update UI immediately
                    button.classList.remove('liked');
                    heartIcon.textContent = 'ü§ç';
                    
                    // Delete user like
                    const { error: deleteError } = await supabase
                        .from('user_song_likes')
                        .delete()
                        .eq('song_id', songId)
                        .eq('user_id', userId);
                    
                    if (deleteError) throw deleteError;
                    
                    // Get current count
                    const { data: currentData } = await supabase
                        .from('song_likes')
                        .select('count')
                        .eq('song_id', songId)
                        .maybeSingle();
                    
                    // Update count
                    const newCount = Math.max(0, (currentData?.count || 1) - 1);
                    const { error: updateError } = await supabase
                        .from('song_likes')
                        .upsert({ 
                            song_id: songId, 
                            count: newCount
                        });
                    
                    if (updateError) throw updateError;
                    likeCount.textContent = newCount;
                    
                } else {
                    // Like - Update UI immediately
                    button.classList.add('liked');
                    heartIcon.textContent = '‚ù§Ô∏è';
                    
                    // Insert user like
                    const { error: insertError } = await supabase
                        .from('user_song_likes')
                        .insert({ song_id: songId, user_id: userId });
                    
                    if (insertError) throw insertError;
                    
                    // Get current count
                    const { data: currentData } = await supabase
                        .from('song_likes')
                        .select('count')
                        .eq('song_id', songId)
                        .maybeSingle();
                    
                    // Update count
                    const newCount = (currentData?.count || 0) + 1;
                    const { error: updateError } = await supabase
                        .from('song_likes')
                        .upsert({ 
                            song_id: songId, 
                            count: newCount
                        });
                    
                    if (updateError) throw updateError;
                    likeCount.textContent = newCount;
                }
            } catch (error) {
                console.error('Error toggling like:', error);
                // Reload to get correct state
                const likesData = await getSongLikes(songId);
                const isLiked = await getUserLikeStatus(songId);
                likeCount.textContent = likesData.count || 0;
                if (isLiked) {
                    button.classList.add('liked');
                    heartIcon.textContent = '‚ù§Ô∏è';
                } else {
                    button.classList.remove('liked');
                    heartIcon.textContent = 'ü§ç';
                }
            } finally {
                // Re-enable button
                button.disabled = false;
            }
        }

        // Load like counts on page load
        async function loadSongLikes() {
            const songs = ['lovestory', 'pahina'];
            for (const songId of songs) {
                try {
                    const likesData = await getSongLikes(songId);
                    const isLiked = await getUserLikeStatus(songId);
                    const button = document.getElementById(`like-${songId}`);
                    
                    if (button) {
                        const heartIcon = button.querySelector('.heart-icon');
                        const likeCount = button.querySelector('.like-count');
                        
                        likeCount.textContent = likesData.count || 0;
                        if (isLiked) {
                            button.classList.add('liked');
                            heartIcon.textContent = '‚ù§Ô∏è';
                        } else {
                            button.classList.remove('liked');
                            heartIcon.textContent = 'ü§ç';
                        }
                    }
                } catch (error) {
                    console.error('Error loading likes for', songId, error);
                }
            }
        }

        // Load likes when page loads
        window.addEventListener('DOMContentLoaded', loadSongLikes);

        // Comment functionality with Supabase
        async function getComments(songId) {
            const { data, error } = await supabase
                .from('comments')
                .select('*')
                .eq('song_id', songId)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching comments:', error);
                return [];
            }
            
            return data || [];
        }

        async function saveComment(songId, comment) {
            const { data, error } = await supabase
                .from('comments')
                .insert([{ ...comment, song_id: songId }])
                .select();
            
            if (error) {
                console.error('Error saving comment:', error);
                return null;
            }
            
            return data[0];
        }

        async function updateComment(commentId, updates) {
            const { data, error } = await supabase
                .from('comments')
                .update(updates)
                .eq('id', commentId)
                .select();
            
            if (error) {
                console.error('Error updating comment:', error);
                return null;
            }
            
            return data[0];
        }

        async function toggleComments(songId) {
            console.log('toggleComments called with:', songId);
            const commentSection = document.getElementById(`${songId}-comments`);
            console.log('commentSection found:', commentSection);
            if (commentSection.style.display === 'none' || commentSection.style.display === '') {
                commentSection.style.display = 'block';
                commentSection.style.animation = 'fadeIn 0.5s ease';
                await loadComments(songId);
            } else {
                commentSection.style.display = 'none';
            }
        }

        async function submitComment(songId) {
            const textInput = document.querySelector(`#${songId}-comments .comment-text`);
            const submitButton = document.querySelector(`#${songId}-comments .btn-submit-comment`);
            
            const text = textInput.value.trim();
            
            // Use logged-in user's email username
            const displayName = currentUser ? currentUser.email.split('@')[0] : 'Anonymous';
            
            if (!text) {
                alert('Please enter your comment!');
                return;
            }
            
            // Disable button to prevent spam
            submitButton.disabled = true;
            submitButton.textContent = 'Posting...';
            
            try {
                const newComment = {
                    name: displayName,
                    text: text,
                    created_at: new Date().toISOString(),
                    hearts: 0,
                    replies: [],
                    hearted_by: [],
                    user_id: generateUserId()
                };
                
                await saveComment(songId, newComment);
                
                textInput.value = '';
                
                await loadComments(songId);
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = 'Post Comment';
            }
        }

        async function loadComments(songId) {
            const comments = await getComments(songId);
            const commentsList = document.getElementById(`${songId}-comments-list`);
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="no-comments">No comments yet. Be the first to share your thoughts!</p>';
                return;
            }
            
            commentsList.innerHTML = comments.map((comment, index) => {
                const commentDate = new Date(comment.created_at);
                const date = commentDate.toLocaleDateString();
                const time = commentDate.toLocaleTimeString();
                const replyCount = comment.replies ? comment.replies.length : 0;
                const showRepliesButton = replyCount > 0 
                    ? `<button class="btn-view-replies" onclick="toggleReplies('${songId}', '${comment.id}')">
                         View ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}
                       </button>`
                    : '';
                
                const repliesHtml = comment.replies && comment.replies.length > 0 
                    ? comment.replies.map((reply, replyIndex) => {
                        const escapedName = reply.name.replace(/'/g, "\\'");
                        return `
                        <div class="tiktok-reply-item">
                            <div class="reply-main">
                                <span class="reply-author">${reply.name}</span>
                                ${reply.replyingTo ? `<span class="replying-to">@${reply.replyingTo}</span>` : ''}
                            </div>
                            <div class="reply-body">${reply.text}</div>
                            <div class="reply-meta">
                                <span class="reply-date">${reply.date}</span>
                                <button class="btn-tiktok-heart ${reply.hearted ? 'hearted' : ''}" onclick="toggleReplyHeart('${songId}', '${comment.id}', ${replyIndex})">
                                    ${reply.hearts || 0}
                                </button>
                                <button class="btn-tiktok-reply" onclick="showTikTokReplyBox('${songId}', '${comment.id}', ${replyIndex}, '${escapedName}')">Reply</button>
                            </div>
                        </div>
                    `;
                    }).join('')
                    : '';
                
                return `
                <div class="comment-item" id="${songId}-comment-${comment.id}">
                    <div class="comment-header">
                        <span class="comment-author">üë§ ${comment.name}</span>
                        <span class="comment-date">${date} at ${time}</span>
                    </div>
                    <p class="comment-content">${comment.text}</p>
                    <div class="comment-actions">
                        <button class="btn-heart-comment ${comment.hearted_by && comment.hearted_by.includes(generateUserId()) ? 'hearted' : ''}" onclick="toggleHeart('${songId}', '${comment.id}')">
                            ‚ù§Ô∏è ${comment.hearts || 0}
                        </button>
                        <button class="btn-reply-comment" onclick="showReplyBox('${songId}', '${comment.id}')">Reply</button>
                        ${comment.user_id === generateUserId() ? `<button class="btn-delete-comment" onclick="deleteComment('${songId}', '${comment.id}')">Delete</button>` : ''}
                    </div>
                    ${showRepliesButton}
                    <div class="reply-box" id="${songId}-reply-${comment.id}" style="display: none;">
                        <textarea class="reply-text" placeholder="Write your reply..." rows="2"></textarea>
                        <input type="hidden" class="replying-to-name" value="" />
                        <div class="reply-buttons">
                            <button class="btn-submit-reply" onclick="submitReply('${songId}', '${comment.id}')">Post Reply</button>
                            <button class="btn-cancel-reply" onclick="hideReplyBox('${songId}', '${comment.id}')">Cancel</button>
                        </div>
                    </div>
                    <div class="tiktok-replies-container" id="${songId}-replies-${comment.id}" style="display: none;">
                        ${repliesHtml}
                    </div>
                </div>
            `;
            }).join('');

        }


        async function toggleHeart(songId, commentId) {
            const userId = generateUserId();
            const comments = await getComments(songId);
            const comment = comments.find(c => c.id == commentId);
            
            if (!comment) return;
            
            let heartedBy = comment.hearted_by || [];
            let hearts = comment.hearts || 0;
            
            if (heartedBy.includes(userId)) {
                // Remove heart
                heartedBy = heartedBy.filter(id => id !== userId);
                hearts = Math.max(0, hearts - 1);
            } else {
                // Add heart
                heartedBy.push(userId);
                hearts++;
            }
            
            await updateComment(commentId, { 
                hearted_by: heartedBy,
                hearts: hearts
            });
            
            await loadComments(songId);
        }

        function showReplyBox(songId, commentId) {
            const replyBox = document.getElementById(`${songId}-reply-${commentId}`);
            replyBox.style.display = 'block';
            replyBox.style.animation = 'fadeIn 0.3s ease';
        }

        function hideReplyBox(songId, commentId) {
            const replyBox = document.getElementById(`${songId}-reply-${commentId}`);
            replyBox.style.display = 'none';
        }

        async function submitReply(songId, commentId) {
            const replyBox = document.getElementById(`${songId}-reply-${commentId}`);
            const textInput = replyBox.querySelector('.reply-text');
            const replyingToInput = replyBox.querySelector('.replying-to-name');
            const submitButton = replyBox.querySelector('.btn-submit-reply');
            
            const text = textInput.value.trim();
            const replyingTo = replyingToInput.value;
            
            // Use logged-in user's email username
            const name = currentUser ? currentUser.email.split('@')[0] : 'Anonymous';
            
            if (!text) {
                alert('Please enter your reply!');
                return;
            }
            
            // Disable button to prevent spam
            submitButton.disabled = true;
            submitButton.textContent = 'Posting...';
            
            try {
                const comments = await getComments(songId);
                const comment = comments.find(c => c.id == commentId);
                
                if (!comment) return;
                
                const newReply = {
                    name: name,
                    text: text,
                    replyingTo: replyingTo || '',
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    hearts: 0,
                    hearted: false
                };
                
                const updatedReplies = [...(comment.replies || []), newReply];
                
                await updateComment(commentId, { replies: updatedReplies });
                
                textInput.value = '';
                hideReplyBox(songId, commentId);
                
                await loadComments(songId);
                
                // Automatically show replies after posting
                setTimeout(() => {
                    const repliesContainer = document.getElementById(`${songId}-replies-${commentId}`);
                    if (repliesContainer) {
                        repliesContainer.style.display = 'block';
                    }
                }, 100);
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = 'Post Reply';
            }
        }

        function toggleReplies(songId, commentId) {
            const repliesContainer = document.getElementById(`${songId}-replies-${commentId}`);
            const button = event.target;
            
            if (repliesContainer.style.display === 'none') {
                repliesContainer.style.display = 'block';
                repliesContainer.style.animation = 'fadeIn 0.3s ease';
                button.textContent = 'Hide replies';
            } else {
                repliesContainer.style.display = 'none';
                // Update button text with reply count
                const commentItem = document.getElementById(`${songId}-comment-${commentId}`);
                const replyCount = commentItem.querySelectorAll('.tiktok-reply-item').length;
                button.textContent = `View ${replyCount} ${replyCount === 1 ? 'reply' : 'replies'}`;
            }
        }

        function showTikTokReplyBox(songId, commentId, replyIndex, replyToName) {
            const replyBox = document.getElementById(`${songId}-reply-${commentId}`);
            const replyingToInput = replyBox.querySelector('.replying-to-name');
            const textInput = replyBox.querySelector('.reply-text');
            
            replyingToInput.value = replyToName;
            textInput.placeholder = `Replying to @${replyToName}...`;
            textInput.focus();
            
            replyBox.style.display = 'block';
            replyBox.style.animation = 'fadeIn 0.3s ease';
            
            // Scroll to reply box
            replyBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function toggleReplyHeart(songId, commentId, replyIndex) {
            // Reply hearts can be implemented similarly with nested updates
            console.log('Reply heart toggled');
        }

        async function deleteComment(songId, commentId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .eq('id', commentId);
                
                if (error) {
                    console.error('Error deleting comment:', error);
                    return;
                }
                
                await loadComments(songId);
            }
        }
    </script>
</body>
</html>
